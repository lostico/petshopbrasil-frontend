<app-page-container>
  <!-- Header -->
  <app-page-header
    title="Vacinas"
    subtitle="Gerencie as vacinas cadastradas na clínica"
    [action]="{
      label: 'Nova Vacina',
      icon: 'plus',
      variant: 'primary'
    }"
    (actionClick)="onNewVaccine()">
  </app-page-header>

  <!-- Filtros -->
  <div class="mb-6">
    <app-card>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Busca -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
          <app-input 
            type="text" 
            placeholder="Nome, descrição ou fabricante..." 
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()" 
            class="w-full">
          </app-input>
        </div>

        <!-- Tipo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
          <app-select 
            [(ngModel)]="selectedType" 
            (ngModelChange)="onFilterChange()" 
            [options]="typeOptions"
            class="w-full">
          </app-select>
        </div>

        <!-- Espécie -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Espécie</label>
          <app-select 
            [(ngModel)]="selectedSpecies" 
            (ngModelChange)="onFilterChange()" 
            [options]="speciesOptions"
            class="w-full">
          </app-select>
        </div>

        <!-- Status -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <app-select 
            [(ngModel)]="selectedStatus" 
            (ngModelChange)="onFilterChange()" 
            [options]="statusOptions"
            class="w-full">
          </app-select>
        </div>
      </div>
    </app-card>
  </div>

  <!-- Lista de Vacinas -->
  <app-card>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Vacina
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Tipo
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Espécies
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Fabricante
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Status
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Vacinações
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Ações
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngIf="loading" class="animate-pulse">
            <td colspan="7" class="px-6 py-4">
              <div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-2 text-gray-600">Carregando...</span>
              </div>
            </td>
          </tr>

          <tr *ngIf="!loading && vaccines.length === 0" class="hover:bg-gray-50">
            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
              Nenhuma vacina encontrada
            </td>
          </tr>

          <tr *ngFor="let vaccine of vaccines" class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div>
                <div class="text-sm font-medium text-gray-900">{{ vaccine.name }}</div>
                <div *ngIf="vaccine.description" class="text-sm text-gray-500 truncate max-w-xs">
                  {{ vaccine.description }}
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <app-badge 
                [variant]="'secondary'" 
                [text]="getTypeName(vaccine.type)" 
                [class]="getTypeBadgeClass(vaccine.type) + ' text-xs'">
              </app-badge>
            </td>
            <td class="px-6 py-4">
              <div class="flex flex-wrap gap-1">
                <app-badge 
                  *ngFor="let species of vaccine.species" 
                  [variant]="'secondary'" 
                  [text]="getSpeciesName(species)"
                  class="text-xs">
                </app-badge>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ vaccine.manufacturer || '-' }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <app-badge 
                [variant]="vaccine.isActive ? 'success' : 'danger'" 
                [text]="getStatusText(vaccine.isActive)"
                class="text-xs">
              </app-badge>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ vaccine._count?.vaccinations || 0 }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex items-center space-x-2">
                <app-button 
                  variant="ghost" 
                  size="sm" 
                  icon="eye" 
                  (clicked)="onViewVaccine(vaccine)"
                  class="text-blue-600 hover:text-blue-900"
                  [title]="'Visualizar'">
                </app-button>

                <app-button 
                  variant="ghost" 
                  size="sm" 
                  icon="edit" 
                  (clicked)="onEditVaccine(vaccine)"
                  class="text-indigo-600 hover:text-indigo-900"
                  [title]="'Editar'">
                </app-button>

                <app-button 
                  variant="ghost" 
                  size="sm" 
                  [icon]="vaccine.isActive ? 'x' : 'check'"
                  (clicked)="onToggleStatus(vaccine)"
                  [class]="vaccine.isActive ? 'text-yellow-600 hover:text-yellow-900' : 'text-green-600 hover:text-green-900'"
                  [title]="vaccine.isActive ? 'Desativar' : 'Ativar'">
                </app-button>

                <app-button 
                  variant="ghost" 
                  size="sm" 
                  icon="trash" 
                  (clicked)="onDeleteVaccine(vaccine)"
                  class="text-red-600 hover:text-red-900"
                  [title]="'Excluir'">
                </app-button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    <app-pagination
      [config]="paginationConfig"
      (pageChange)="onPageChange($event)"
      class="mt-4">
    </app-pagination>
  </app-card>

  <!-- Modal de Confirmação de Exclusão -->
  <app-modal *ngIf="showDeleteModal" [isOpen]="showDeleteModal" (close)="cancelDelete()">
    <div class="p-6">
      <div class="flex items-center mb-4">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
            </path>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-lg font-medium text-gray-900">Confirmar Exclusão</h3>
        </div>
      </div>

      <div class="mb-6">
        <p class="text-sm text-gray-500">
          Tem certeza que deseja excluir a vacina <strong>{{ vaccineToDelete?.name }}</strong>?
        </p>
        
        <div *ngIf="vaccineToDelete && vaccineToDelete._count && vaccineToDelete._count.vaccinations > 0" 
             class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
          <div class="flex">
            <svg class="h-5 w-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
              </path>
            </svg>
            <div class="ml-3">
              <p class="text-sm text-yellow-800">
                <strong>Atenção:</strong> Esta vacina possui <strong>{{ vaccineToDelete._count.vaccinations }}</strong> vacinação(ões) registrada(s).
              </p>
              <p class="text-sm text-yellow-700 mt-1">
                A vacina será desativada para preservar o histórico, mas não será deletada permanentemente.
              </p>
            </div>
          </div>
        </div>

        <div *ngIf="vaccineToDelete && (!vaccineToDelete._count || !vaccineToDelete._count.vaccinations || vaccineToDelete._count.vaccinations === 0)" 
             class="mt-3 p-3 bg-red-50 border border-red-200 rounded-md">
          <div class="flex">
            <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
              </path>
            </svg>
            <div class="ml-3">
              <p class="text-sm text-red-800">
                <strong>Atenção:</strong> Esta ação não pode ser desfeita. A vacina será deletada permanentemente.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end space-x-3">
        <app-button variant="secondary" label="Cancelar" (clicked)="cancelDelete()">
        </app-button>
        <app-button variant="danger" label="Excluir" (clicked)="confirmDelete()">
        </app-button>
      </div>
    </div>
  </app-modal>

  <!-- Modal de Confirmação de Alteração de Status -->
  <app-modal *ngIf="showStatusModal" [isOpen]="showStatusModal" (close)="cancelToggleStatus()">
    <div class="p-6">
      <div class="flex items-center mb-4">
        <div class="flex-shrink-0">
          <svg *ngIf="vaccineToToggle?.isActive" class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
            </path>
          </svg>
          <svg *ngIf="!vaccineToToggle?.isActive" class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M5 13l4 4L19 7">
            </path>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-lg font-medium text-gray-900">
            {{ vaccineToToggle?.isActive ? 'Desativar' : 'Ativar' }} Vacina
          </h3>
        </div>
      </div>

      <div class="mb-6">
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <h4 class="font-medium text-gray-900 mb-2">{{ vaccineToToggle?.name }}</h4>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-gray-500">Tipo:</span>
              <p class="font-medium">{{ getTypeName(vaccineToToggle?.type || VaccineType.CORE) }}</p>
            </div>
            <div>
              <span class="text-gray-500">Status atual:</span>
              <app-badge 
                [variant]="vaccineToToggle?.isActive ? 'success' : 'danger'" 
                [text]="getStatusText(vaccineToToggle?.isActive || false)"
                class="text-xs">
              </app-badge>
            </div>
          </div>
        </div>

        <p class="text-sm text-gray-500">
          Tem certeza que deseja 
          <strong>{{ vaccineToToggle?.isActive ? 'desativar' : 'ativar' }}</strong> 
          esta vacina?
        </p>
        
        <div *ngIf="vaccineToToggle?.isActive" class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
          <div class="flex">
            <svg class="h-5 w-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
              </path>
            </svg>
            <div class="ml-3">
              <p class="text-sm text-yellow-800">
                <strong>Atenção:</strong> Vacinas desativadas não aparecerão para seleção em novas vacinações.
              </p>
            </div>
          </div>
        </div>

        <div *ngIf="!vaccineToToggle?.isActive" class="mt-3 p-3 bg-green-50 border border-green-200 rounded-md">
          <div class="flex">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 13l4 4L19 7">
              </path>
            </svg>
            <div class="ml-3">
              <p class="text-sm text-green-800">
                <strong>Informação:</strong> Esta vacina voltará a aparecer para seleção em novas vacinações.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end space-x-3">
        <app-button variant="secondary" label="Cancelar" (clicked)="cancelToggleStatus()">
        </app-button>
        <app-button 
          [variant]="vaccineToToggle?.isActive ? 'danger' : 'primary'" 
          [label]="vaccineToToggle?.isActive ? 'Desativar' : 'Ativar'"
          (clicked)="confirmToggleStatus()">
        </app-button>
      </div>
    </div>
  </app-modal>
</app-page-container>

